<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - PowerBill</title>
    <style>
        :root {
            --primary: #1e3a8a;
            --primary-light: #3b82f6;
            --bg-body: #f3f4f6;
            --surface: #ffffff;
            --text-heading: #111827;
            --text-body: #374151;
            --border: #d1d5db;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-body);
            margin: 0;
            padding: 0;
        }

        .header {
            background-color: var(--primary);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: -0.025em;
        }

        .logout-link {
            color: #dbeafe;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }

        .logout-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--surface);
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
        }

        .card h3 {
            margin-top: 0;
            color: var(--text-heading);
            font-size: 1.25rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.75rem;
            margin-bottom: 1.5rem;
        }

        input,
        select {
            width: 100%;
            padding: 0.625rem;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            box-sizing: border-box;
            font-size: 0.95rem;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        button.primary-btn {
            width: 100%;
            background-color: var(--primary-light);
            color: white;
            padding: 0.75rem;
            border: none;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button.primary-btn:hover {
            background-color: #2563eb;
        }

        .table-section {
            background: var(--surface);
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
            margin-top: 1rem;
        }

        th {
            background-color: #f9fafb;
            padding: 0.75rem 1rem;
            font-weight: 600;
            color: var(--text-heading);
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
            text-transform: uppercase;
        }

        td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.95rem;
        }

        tr:hover {
            background-color: #f9fafb;
        }

        .action-btn {
            background-color: white;
            border: 1px solid var(--border);
            padding: 0.4rem 0.8rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .action-btn:hover {
            border-color: var(--primary-light);
            color: var(--primary-light);
        }

        .refresh-btn {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            color: var(--text-body);
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 500;
            margin-bottom: 1rem;
        }

        .refresh-btn:hover {
            background-color: #e5e7eb;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.2s;
        }

        .modal-content {
            background-color: var(--surface);
            margin: 5% auto;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn-cancel {
            background: transparent;
            border: 1px solid var(--border);
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>Admin Console</h1>
        <a href="/" class="logout-link">Sign Out</a>
    </div>

    <div class="container">

        <div class="dashboard-grid">
            <!-- Consumer Registration -->
            <div class="card">
                <h3>New Consumer</h3>
                <form onsubmit="registerUser(event, 'consumer')">
                    <input type="text" name="consumer_username" placeholder="Username" required>
                    <input type="password" name="consumer_password" placeholder="Password" required>
                    <div id="consumer-password-error" class="error-text"
                        style="color:red; font-size:12px; display:none; margin-top:-10px; margin-bottom:10px;"></div>
                    <input type="text" name="consumer_name" placeholder="Full Name" required>
                    <div id="consumer-name-error" class="error-text"
                        style="color:red; font-size:12px; display:none; margin-top:-10px; margin-bottom:10px;"></div>
                    <input type="text" name="consumer_mobile" placeholder="Mobile Number" required>
                    <div id="consumer-mobile-error" class="error-text"
                        style="color:red; font-size:12px; display:none; margin-top:-10px; margin-bottom:10px;"></div>
                    <input type="text" name="consumer_address" placeholder="Address" required>
                    <input type="text" name="consumer_meterno" placeholder="Meter Number" required>
                    <select name="consumer_metertype" required>
                        <option value="household">Household</option>
                        <option value="commercial">Commercial</option>
                        <option value="industrial">Industrial</option>
                    </select>
                    <div id="consumer-global-error" class="error-text"
                        style="color:red; font-size:12px; display:none; margin-bottom:10px;"></div>
                    <button type="submit" class="primary-btn">Create Consumer</button>
                </form>
            </div>

            <!-- Employee Registration -->
            <div class="card">
                <h3>New Employee</h3>
                <form onsubmit="registerUser(event, 'employee')">
                    <input type="text" name="employee_username" placeholder="Username" required>
                    <input type="password" name="employee_password" placeholder="Password" required>
                    <div id="employee-password-error" class="error-text"
                        style="color:red; font-size:12px; display:none; margin-top:-10px; margin-bottom:10px;"></div>
                    <input type="text" name="employee_name" placeholder="Full Name" required>
                    <div id="employee-name-error" class="error-text"
                        style="color:red; font-size:12px; display:none; margin-top:-10px; margin-bottom:10px;"></div>
                    <input type="text" name="employee_mobile" placeholder="Mobile Number" required>
                    <div id="employee-mobile-error" class="error-text"
                        style="color:red; font-size:12px; display:none; margin-top:-10px; margin-bottom:10px;"></div>
                    <div id="employee-global-error" class="error-text"
                        style="color:red; font-size:12px; display:none; margin-bottom:10px;"></div>
                    <button type="submit" class="primary-btn">Create Employee</button>
                </form>
            </div>
        </div>

        <div class="table-section">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>User Management</h3>
                <button onclick="fetchUsers()" class="refresh-btn">â†» Refresh</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Role</th>
                        <th>User ID</th>
                        <th>Name</th>
                        <th>Contact</th>
                        <th>Address</th>
                        <th>Meter Info</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <tr>
                        <td colspan="7" style="text-align:center;">Loading users...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top:0;">Edit User Details</h2>
            <input type="hidden" id="edit_username">
            <label>Name</label>
            <input type="text" id="edit_name">
            <label>Mobile</label>
            <input type="text" id="edit_mobile">
            <label>Address</label>
            <input type="text" id="edit_address">
            <label>Meter No</label>
            <input type="text" id="edit_meterno">
            <label>Meter Type</label>
            <select id="edit_metertype">
                <option value="household">Household</option>
                <option value="commercial">Commercial</option>
                <option value="industrial">Industrial</option>
            </select>

            <div class="modal-actions">
                <button onclick="document.getElementById('editModal').style.display='none'"
                    class="btn-cancel">Cancel</button>
                <button onclick="submitEdit()" class="primary-btn" style="width: auto;">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        async function registerUser(event, roleArg) {
            event.preventDefault();

            // If registering an employee, set the actual DB role to 'supervisor'
            // The UI says "Employee", but the DB role must be "supervisor"
            const dbRole = roleArg === 'employee' ? 'supervisor' : 'consumer';
            const prefix = roleArg === 'consumer' ? 'consumer_' : 'employee_';

            const username = document.querySelector(`input[name="${prefix}username"]`).value;
            const password = document.querySelector(`input[name="${prefix}password"]`).value;
            const name = document.querySelector(`input[name="${prefix}name"]`).value;
            const mobileno = document.querySelector(`input[name="${prefix}mobile"]`).value;

            // --- Validation ---
            let hasError = false;

            // Clear previous errors
            document.querySelectorAll('.error-text').forEach(el => el.style.display = 'none');

            // Name Validation
            if (name.length > 32) {
                const errorId = roleArg === 'consumer' ? 'consumer-name-error' : 'employee-name-error';
                const errorEl = document.getElementById(errorId);
                if (errorEl) {
                    errorEl.innerText = "Name must be at most 32 characters.";
                    errorEl.style.display = 'block';
                }
                hasError = true;
            }

            // Password Validation
            if (password.length > 32) {
                const errorId = roleArg === 'consumer' ? 'consumer-password-error' : 'employee-password-error';
                const errorEl = document.getElementById(errorId);
                if (errorEl) {
                    errorEl.innerText = "Password must be at most 32 characters.";
                    errorEl.style.display = 'block';
                }
                hasError = true;
            } else if (password.length < 8) {
                const errorId = roleArg === 'consumer' ? 'consumer-password-error' : 'employee-password-error';
                const errorEl = document.getElementById(errorId);
                if (errorEl) {
                    errorEl.innerText = "Password must be at least 8 characters.";
                    errorEl.style.display = 'block';
                }
                hasError = true;
            }

            // Mobile Validation
            if (!/^\d{10}$/.test(mobileno)) {
                // Show inline error
                const errorId = roleArg === 'consumer' ? 'consumer-mobile-error' : 'employee-mobile-error';
                const errorEl = document.getElementById(errorId);
                if (errorEl) {
                    errorEl.innerText = "Mobile number must be exactly 10 digits.";
                    errorEl.style.display = 'block';
                }
                hasError = true;
            }

            if (hasError) return;

            let data = { username, password, name, mobileno, role: dbRole };

            if (roleArg === 'consumer') {
                data.address = document.querySelector(`input[name="${prefix}address"]`).value;
                data.meterno = document.querySelector(`input[name="${prefix}meterno"]`).value;
                data.meter_type = document.querySelector(`select[name="${prefix}metertype"]`).value;
            }

            try {
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (response.ok) {
                    alert(result.message); // Success message can stay as alert or toast, user asked for "error message"
                    fetchUsers();
                    // Reset form?
                    event.target.reset();
                } else {
                    const globalErrorId = roleArg === 'consumer' ? 'consumer-global-error' : 'employee-global-error';
                    const errorEl = document.getElementById(globalErrorId);
                    if (errorEl) {
                        errorEl.innerText = result.message;
                        errorEl.style.display = 'block';
                    } else {
                        alert(result.message);
                    }
                }
            } catch (e) {
                const globalErrorId = roleArg === 'consumer' ? 'consumer-global-error' : 'employee-global-error';
                const errorEl = document.getElementById(globalErrorId);
                if (errorEl) {
                    errorEl.innerText = "Request failed. Please try again.";
                    errorEl.style.display = 'block';
                }
            }
        }

        async function fetchUsers() {
            try {
                const response = await fetch('/all-users');
                const users = await response.json();
                const tbody = document.getElementById('userTableBody');
                tbody.innerHTML = '';

                users.forEach(user => {
                    if (user.role === 'admin') return; // Hide admin

                    const meterInfo = user.meter_no ? `<strong>${user.meter_no}</strong><br><small>${user.meter_type}</small>` : '-';
                    const row = `<tr>
                        <td><span style="background:${user.role === 'consumer' ? '#d1fae5' : '#e0f2fe'}; color:${user.role === 'consumer' ? '#047857' : '#0369a1'}; padding:2px 6px; border-radius:4px; font-size:0.75rem; text-transform:uppercase;">${user.role}</span></td>
                        <td>${user.username}</td>
                        <td>${user.name || ''}</td>
                        <td>${user.mobile || ''}</td>
                        <td>${user.address || '-'}</td>
                        <td>${meterInfo}</td>
                        <td>
                            <button onclick='editUser(${JSON.stringify(user)})' class="action-btn">Edit</button>
                            <button onclick="deleteUser('${user.username}')" class="action-btn" style="color: #ef4444; border-color: #fca5a5; margin-left: 5px;">Delete</button>
                        </td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (err) {
                document.getElementById('userTableBody').innerHTML = '<tr><td colspan="7">Failed to load data</td></tr>';
            }
        }

        async function deleteUser(username) {
            if (confirm("Are you sure you want to delete user: " + username + "?")) {
                try {
                    const response = await fetch('/delete-user', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: username })
                    });
                    const result = await response.json();
                    alert(result.message);
                    fetchUsers();
                } catch (err) {
                    alert("Deletion failed");
                }
            }
        }

        function editUser(user) {
            document.getElementById('edit_username').value = user.username;
            document.getElementById('edit_name').value = user.name || '';
            document.getElementById('edit_mobile').value = user.mobile || '';
            document.getElementById('edit_address').value = user.address || '';
            document.getElementById('edit_meterno').value = user.meter_no || '';
            if (user.meter_type) document.getElementById('edit_metertype').value = user.meter_type;

            document.getElementById('editModal').style.display = 'block';
        }

        async function submitEdit() {
            const data = {
                username: document.getElementById('edit_username').value,
                name: document.getElementById('edit_name').value,
                mobileno: document.getElementById('edit_mobile').value,
                address: document.getElementById('edit_address').value,
                meterno: document.getElementById('edit_meterno').value,
                meter_type: document.getElementById('edit_metertype').value
            };

            const response = await fetch('/update-user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            alert(result.message);
            document.getElementById('editModal').style.display = 'none';
            fetchUsers();
        }

        fetchUsers();
    </script>
</body>

</html>